---
import Book from "@/icons/book.astro";
import Base from "../../layouts/Base.astro";

export const prerender = true;

const BLOG_REPO = "AbhinRustagi/blog";

interface PostMeta {
  title: string;
  date: string;
  slug: string;
  path: string;
  description?: string;
  tags: string[];
  reading_time: number;
  published: boolean;
}

const res = await fetch(
  `https://raw.githubusercontent.com/${BLOG_REPO}/main/index.json`
);
const index: PostMeta[] = await res.json();

const posts = index
  .filter((p) => p.published)
  .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf());
---

<Base
  title="Writing - Abhin Rustagi"
  description="Thoughts on web development, freelancing, and building products."
>
  <section>
    <div class="container section-wrapper">
      <h1 class="section-title">
        <Book size={20} class="section-title-icon" />Writing
      </h1>
      <p class="text-muted desc">
        Thoughts, opinions and learnings on development and building products.
        Check out the Github source for this blog <a
          href="https://github.com/AbhinRustagi/blog">here</a
        >.
      </p>

      {
        posts.length === 0 ? (
          <p class="empty text-muted">No posts yet. Check back soon.</p>
        ) : (
          <div class="timeline">
            {posts.map((post, i) => (
              <div
                class={`timeline-item animate-in animate-in-delay-${Math.min(i + 1, 4)}`}
              >
                <div class="timeline-content">
                  <a href={`/blog/${post.slug}`} class="post-link">
                    {post.title}
                  </a>
                  {post.description && (
                    <p class="post-desc">{post.description}</p>
                  )}
                  <p class="view-count text-muted" data-slug={post.slug} />
                </div>
                <span class="timeline-date">
                  {new Date(post.date).toLocaleDateString("en-US", {
                    month: "short",
                    year: "2-digit",
                    day: "numeric",
                  })}
                </span>
              </div>
            ))}
          </div>
        )
      }
    </div>
  </section>
</Base>

<script>
  document
    .querySelectorAll<HTMLElement>(".view-count[data-slug]")
    .forEach((el) => {
      const slug = el.dataset.slug;
      if (!slug) return;

      fetch(`/api/views?slug=${encodeURIComponent(slug)}`)
        .then((res) => res.json())
        .then((data) => {
          if (data.views >= 15) {
            el.textContent = `${data.views} views`;
          }
        });
    });
</script>

<style>
  .desc {
    margin-bottom: var(--space-xl);
  }

  .page-header {
    margin-bottom: var(--space-xl);
  }

  .page-header h1 {
    margin-bottom: var(--space-sm);
  }

  .empty {
    padding: var(--space-xl) 0;
  }

  .post-link {
    font-family: var(--font-mono);
    font-weight: 500;
    font-size: 0.9375rem;
    color: var(--text);
  }

  .post-link:hover {
    color: var(--accent);
  }

  .post-desc {
    margin: var(--space-xs) 0 0;
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .timeline-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
  }

  .view-count:empty {
    display: none;
  }

  .view-count {
    font-size: 0.75rem;
  }
</style>
