---
import Base from "../../layouts/Base.astro";
import { marked } from "marked";

export const prerender = true;

interface PostMeta {
  title: string;
  date: string;
  slug: string;
  path: string;
  description?: string;
  tags: string[];
  reading_time: number;
  published: boolean;
}

export async function getStaticPaths() {
  const BLOG_REPO = "AbhinRustagi/blog";

  function parseFrontmatter(raw: string): {
    data: Record<string, any>;
    content: string;
  } {
    const match = raw.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
    if (!match) return { data: {}, content: raw };

    const [, frontmatterStr, content] = match;
    const data: Record<string, any> = {};

    for (const line of frontmatterStr.split("\n")) {
      const colonIndex = line.indexOf(":");
      if (colonIndex === -1) continue;

      const key = line.slice(0, colonIndex).trim();
      let value: any = line.slice(colonIndex + 1).trim();

      // Handle quoted strings
      if (
        (value.startsWith('"') && value.endsWith('"')) ||
        (value.startsWith("'") && value.endsWith("'"))
      ) {
        value = value.slice(1, -1);
      }
      // Handle booleans
      else if (value === "true") value = true;
      else if (value === "false") value = false;
      // Handle numbers
      else if (!isNaN(Number(value)) && value !== "") value = Number(value);

      data[key] = value;
    }

    return { data, content };
  }

  const res = await fetch(
    `https://raw.githubusercontent.com/${BLOG_REPO}/main/index.json`
  );
  const index: PostMeta[] = await res.json();

  const posts = await Promise.all(
    index
      .filter((p) => p.published)
      .map(async (meta) => {
        const contentRes = await fetch(
          `https://raw.githubusercontent.com/${BLOG_REPO}/main/${meta.path}`
        );
        const raw = await contentRes.text();
        const { data, content } = parseFrontmatter(raw);

        return {
          params: { slug: meta.slug },
          props: {
            meta: { ...meta, ...data },
            content,
          },
        };
      })
  );

  return posts;
}

const { meta, content } = Astro.props;
const html = await marked.parse(content);
const date = new Date(meta.date);
---

<Base
  title={`${meta.title} - Abhin Rustagi`}
  description={meta.description || meta.title}
>
  <section>
    <div class="container section-wrapper">
      <h1 class="section-title">{meta.title}</h1>
      <div class="meta text-muted text-sm">
        <time>
          {
            date.toLocaleDateString("en-US", {
              month: "long",
              day: "numeric",
              year: "numeric",
            })
          }
        </time>
        <span class="separator">&middot;</span>
        <span id="view-count"></span>
      </div>
      <div class="prose animate-in animate-in-delay-1" set:html={html} />
      <div class="footer">
        <a href="/blog" class="back-link">&larr; Back to all posts</a>
      </div>
    </div>
  </section>
</Base>

<script>
  const slug = window.location.pathname
    .replace(/^\/blog\//, "")
    .replace(/\/$/, "");
  const el = document.getElementById("view-count");

  fetch("/api/views", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ slug }),
  })
    .then((res) => res.json())
    .then((data) => {
      if (data.views >= 15 && el) {
        el.textContent = `${data.views} views`;
      } else {
        if (el) el.style.display = "none";
        const sep = document.querySelector(".separator");
        if (sep) (sep as HTMLElement).style.display = "none";
      }
    })
    .catch(() => {
      if (el) el.style.display = "none";
      const sep = document.querySelector(".separator");
      if (sep) (sep as HTMLElement).style.display = "none";
    });
</script>

<style>
  .meta {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-md);
  }

  .post-header {
    margin-bottom: var(--space-xl);
  }

  .post-header time {
    display: block;
    margin-bottom: var(--space-sm);
  }

  .post-header h1 {
    font-size: 2rem;
  }

  .back-link {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .back-link:hover {
    color: var(--accent);
  }
</style>
