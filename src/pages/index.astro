---
import Pill from "@/components/Pill.astro";
import Book from "@/icons/book.astro";
import { getCollection } from "astro:content";
import Base from "../layouts/Base.astro";
import Mail from "@/icons/mail.astro";
import Linkedin from "@/icons/linkedin.astro";
import Github from "@/icons/github.astro";
import Twitter from "@/icons/twitter.astro";

export const prerender = false;

const BLOG_REPO = "AbhinRustagi/blog";
const PROJECTS_REPO = "AbhinRustagi/projects";
const GITHUB_USERNAME = "AbhinRustagi";

interface PostMeta {
  title: string;
  date: string;
  slug: string;
  path: string;
  description?: string;
  tags: string[];
  reading_time: number;
  published: boolean;
}

interface ProjectMeta {
  title: string;
  date: string;
  slug: string;
  path: string;
  description?: string;
  tags: string[];
  thumbnail?: string;
  published: boolean;
}

// Fetch blog posts from GitHub
const res = await fetch(
  `https://raw.githubusercontent.com/${BLOG_REPO}/main/index.json`
);
const index: PostMeta[] = await res.json();

const posts = index
  .filter((p) => p.published)
  .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf())
  .slice(0, 3);

// Fetch projects from GitHub
let featuredProjects: ProjectMeta[] = [];
try {
  const projectsRes = await fetch(
    `https://raw.githubusercontent.com/${PROJECTS_REPO}/main/index.json`
  );
  if (projectsRes.ok) {
    const projectsIndex: ProjectMeta[] = await projectsRes.json();
    featuredProjects = projectsIndex
      .filter((p) => p.published)
      .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf())
      .slice(0, 3);
  }
} catch (e) {
  console.error("Failed to fetch projects:", e);
}

const featuredWork = (
  await getCollection("work", ({ data }) => data.featured && !data.draft)
)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

// Fetch Wakatime stats (hours coded in last week)
let codingHours = 0;
try {
  const wakatimeKey = import.meta.env.WAKATIME_API_KEY;
  if (wakatimeKey) {
    const wakatimeRes = await fetch(
      "https://wakatime.com/api/v1/users/AbhinRustagi/stats/last_7_days",
      {
        headers: {
          Authorization: `Basic ${Buffer.from(wakatimeKey).toString("base64")}`,
        },
      }
    );
    if (wakatimeRes.ok) {
      const wakatimeData = await wakatimeRes.json();
      const totalSeconds7Days = wakatimeData.data?.total_seconds || 0;
      codingHours = Math.round((totalSeconds7Days / 3600) * 100) / 100; // Round to 2 decimal
    }
  }
} catch (e) {
  console.error("Failed to fetch Wakatime stats:", e);
}

// Fetch GitHub contributions (last year)
let contributions = 0;
try {
  const githubToken = import.meta.env.GITHUB_TOKEN;
  if (githubToken) {
    const query = `
      query($username: String!) {
        user(login: $username) {
          contributionsCollection {
            contributionCalendar {
              totalContributions
            }
          }
        }
      }
    `;
    const githubRes = await fetch("https://api.github.com/graphql", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${githubToken}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        query,
        variables: { username: GITHUB_USERNAME },
      }),
    });
    if (githubRes.ok) {
      const githubData = await githubRes.json();
      contributions =
        githubData.data?.user?.contributionsCollection?.contributionCalendar
          ?.totalContributions ?? 0;
    }
  }
} catch (e) {
  console.error("Failed to fetch GitHub contributions:", e);
}
---

<Base title="Abhin Rustagi - Full-Stack Developer">
  <section class="hero container">
    <div class="hero-img-wrapper">
      <img src="/avatar.jpg" class="hero-img" alt="">
      <h1 class="hero-img-title">Abhin R.</h1>
    </div>
    <div class="hero-subtitle">Hello. I'm Abhin, a Software Engineer with a passion for building systems that blend product thinking and scalability.</div>
    <div class="socials-wrapper">
      <Pill link href="mailto:hi@abhin.dev">
        <Mail size={14} /> Get in touch
      </Pill>
      <Pill link href="https://linkedin.com/in/abhinrustagi">
        <Linkedin size={14} />
      </Pill>
      <Pill link href="https://www.github.com/AbhinRustagi">
        <Github size={14}/>
      </Pill>
      <Pill link href="https">
        <Twitter size={14} />
      </Pill>
    </div>
  </section>

  <section class="container animate-in">
      <h2 class="section-title">
        <!-- <Clock size={20} class="section-title-icon" /> -->
        Now
      </h2>
      <ul class="text-muted now-list">
        <li>Building & breaking with AI</li>
        <li>In Melbourne, Australia</li>
        <li>
          <a
            class="text-muted"
            href="https://wakatime.com/AbhinRustagi"
            target="_blank">{codingHours} hours of coding</a
          > in the last week
        </li>
        <li>
          <a
            class="text-muted"
            href="https://github.com/AbhinRustagi"
            target="_blank">{contributions} contributions</a
          > in the last year
        </li>
      </ul>
  </section>

  {
    featuredProjects.length > 0 && (
      <section class="container animate-in">
          <h2 class="section-title">
            {/* <Flask class="section-title-icon" size={20} /> */}
            Projects
          </h2>
          <ul class="timeline">
            {featuredProjects.map((project) => (
              <li class="timeline-item">
                <div class="timeline-content">
                  <a href={`/projects/${project.slug}`} class="post-link">
                    {project.title}
                  </a>
                  {project.description && (
                    <p class="post-desc">
                      {project.description.length > 140
                        ? project.description.slice(0, 140) + "..."
                        : project.description}
                    </p>
                  )}
                </div>
              </li>
            ))}
          </ul>
          <a href="/projects" class="see-all">
            Explore all
          </a>
      </section>
    )
  }

  {
    featuredWork.length > 0 && (
      <section class="container animate-in">
          <h2 class="section-title">
            {/* <SquarePen size={16} class="section-title-icon" /> */}
            Work Case Studies
          </h2>
          <ul class="timeline">
            {featuredWork.map((work) => (
              <li class="timeline-item">
                <div class="timeline-content">
                  <a href={`/work/${work.slug}`} class="post-link">
                    {work.data.title}
                  </a>
                <span class="timeline-date">
                  {new Date(work.data.date).toLocaleDateString("en-US", {
                    month: "short",
                    year: "2-digit",
                  })}
                </span>
                  </div>
              </li>
            ))}
          </ul>
          <a href="/work" class="see-all">
            Explore all
          </a>
      </section>
    )
  }

  {
    posts.length > 0 && (
      <section class="container animate-in">
          <h2 class="section-title">
            <Book size={20} class="section-title-icon" />
            Writing
          </h2>
          <div class="timeline">
            {posts.map((post) => (
              <div class="timeline-item">
                <div class="timeline-content">
                  <a href={`/blog/${post.slug}`} class="post-link">
                    {post.title}
                  </a>
                <span class="timeline-date">
                  {new Date(post.date).toLocaleDateString("en-US", {
                    month: "short",
                    year: "2-digit",
                    day: "numeric",
                  })}
                </span>
                </div>
              </div>
            ))}
          </div>
          <a href="/blog" class="see-all">
            Read all posts
          </a>
      </section>
    )
  }
</Base>

<style>
  section {
    margin-bottom: var(--space-xl);
  }

  .hero {
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
    align-items: center;
    justify-content: center;
  }

  .hero-img-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
  }

  .hero-img {
    width: 64px;
    height:64px;
    object-fit: cover;
    border-radius: var(--space-sm);
  }

  .hero-img-title {
    font-size: 1.25rem;
    font-weight: 500;
    color: var(--text);
  }
  
  .hero-subtitle {
    font-size: 1.5rem;
    font-weight: 500;
    text-align: center;
    color: var(--text);
  }

  .socials-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-md);
  }

  .now-list {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-sm);
  }

  .logo {
    display: block;
    color: var(--text);
  }

  .img-container {
    display: flex;
    position: relative;
    gap: var(--space-md);
  }

  .img-container > img {
    border-radius: 8px;
    width: 96px;
    height: 96px;
  }

  .now-list {
    padding-left: var(--space-lg);
  }

  .post-link {
    font-weight: 500;
    color: var(--text);
    text-decoration: none;
  }

  .post-link:hover {
    color: var(--accent);
  }

  .post-desc {
    margin: var(--space-xs) 0 0;
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .see-all {
    display: inline-block;
    margin-top: var(--space-lg);
    font-size: 0.9375rem;
    color: var(--text-muted);
  }

  .see-all:hover {
    color: var(--accent);
  }

  @media (max-width: 640px) {
    .see-all {
      margin-left: 0;
    }

    .hero-subtitle {
      font-size: 1.25rem;
    }
  }
</style>
