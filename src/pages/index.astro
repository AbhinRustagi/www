---
import Book from "@/icons/book.astro";
import Clock from "@/icons/clock.astro";
import Flask from "@/icons/flask.astro";
import SquarePen from "@/icons/square-pen.astro";
import User from "@/icons/user.astro";
import { getCollection } from "astro:content";
import Base from "../layouts/Base.astro";

export const prerender = false;

const BLOG_REPO = "AbhinRustagi/blog";
const PROJECTS_REPO = "AbhinRustagi/projects";
const GITHUB_USERNAME = "AbhinRustagi";

interface PostMeta {
  title: string;
  date: string;
  slug: string;
  path: string;
  description?: string;
  tags: string[];
  reading_time: number;
  published: boolean;
}

interface ProjectMeta {
  title: string;
  date: string;
  slug: string;
  path: string;
  description?: string;
  tags: string[];
  thumbnail?: string;
  published: boolean;
}

// Fetch blog posts from GitHub
const res = await fetch(
  `https://raw.githubusercontent.com/${BLOG_REPO}/main/index.json`
);
const index: PostMeta[] = await res.json();

const posts = index
  .filter((p) => p.published)
  .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf())
  .slice(0, 3);

// Fetch projects from GitHub
let featuredProjects: ProjectMeta[] = [];
try {
  const projectsRes = await fetch(
    `https://raw.githubusercontent.com/${PROJECTS_REPO}/main/index.json`
  );
  if (projectsRes.ok) {
    const projectsIndex: ProjectMeta[] = await projectsRes.json();
    featuredProjects = projectsIndex
      .filter((p) => p.published)
      .sort((a, b) => new Date(b.date).valueOf() - new Date(a.date).valueOf())
      .slice(0, 3);
  }
} catch (e) {
  console.error("Failed to fetch projects:", e);
}

const featuredWork = (
  await getCollection("work", ({ data }) => data.featured && !data.draft)
)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, 3);

// Fetch Wakatime stats (hours coded in last week)
let codingHours = 0;
try {
  const wakatimeKey = import.meta.env.WAKATIME_API_KEY;
  if (wakatimeKey) {
    const wakatimeRes = await fetch(
      "https://wakatime.com/api/v1/users/AbhinRustagi/stats/last_7_days",
      {
        headers: {
          Authorization: `Basic ${Buffer.from(wakatimeKey).toString("base64")}`,
        },
      }
    );
    if (wakatimeRes.ok) {
      const wakatimeData = await wakatimeRes.json();
      const totalSeconds7Days = wakatimeData.data?.total_seconds || 0;
      codingHours = Math.round((totalSeconds7Days / 3600) * 100) / 100; // Round to 2 decimal
    }
  }
} catch (e) {
  console.error("Failed to fetch Wakatime stats:", e);
}

// Fetch GitHub contributions (last year)
let contributions = 0;
try {
  const githubToken = import.meta.env.GITHUB_TOKEN;
  if (githubToken) {
    const query = `
      query($username: String!) {
        user(login: $username) {
          contributionsCollection {
            contributionCalendar {
              totalContributions
            }
          }
        }
      }
    `;
    const githubRes = await fetch("https://api.github.com/graphql", {
      method: "POST",
      headers: {
        Authorization: `Bearer ${githubToken}`,
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        query,
        variables: { username: GITHUB_USERNAME },
      }),
    });
    if (githubRes.ok) {
      const githubData = await githubRes.json();
      contributions =
        githubData.data?.user?.contributionsCollection?.contributionCalendar
          ?.totalContributions ?? 0;
    }
  }
} catch (e) {
  console.error("Failed to fetch GitHub contributions:", e);
}
---

<Base title="Abhin Rustagi - Full-Stack Developer">
  <section>
    <div class="container section-wrapper border-dashed-b animate-in">
      <h2 class="section-title">
        <User size={20} class="section-title-icon" />Whoami
      </h2>
      <p class="intro">
        Full-stack developer building thoughtful, performant web experiences.
        Currently freelancing and helping startups ship faster.
      </p>
    </div>
  </section>

  <section>
    <div class="container section-wrapper border-dashed-b animate-in">
      <h2 class="section-title">
        <Clock size={20} class="section-title-icon" />Now
      </h2>
      <ul class="text-muted now-list">
        <li>Looking for a full-time role</li>
        <li>Building & breaking with AI</li>
        <li>In Melbourne, Australia</li>
        <li>
          <a
            class="text-muted"
            href="https://wakatime.com/AbhinRustagi"
            target="_blank">{codingHours} hours of coding</a
          > in the last week
        </li>
        <li>
          <a
            class="text-muted"
            href="https://github.com/AbhinRustagi"
            target="_blank">{contributions} contributions</a
          > in the last year
        </li>
      </ul>
    </div>
  </section>

  {
    featuredProjects.length > 0 && (
      <section>
        <div class="container section-wrapper border-dashed-b animate-in">
          <h2 class="section-title">
            <Flask class="section-title-icon" size={20} />
            Projects
          </h2>
          <div class="timeline">
            {featuredProjects.map((project) => (
              <div class="timeline-item">
                <div class="timeline-content">
                  <a href={`/projects/${project.slug}`} class="post-link">
                    {project.title}
                  </a>
                  {project.description && (
                    <p class="post-desc">
                      {project.description.length > 150
                        ? project.description.slice(0, 150) + "..."
                        : project.description}
                    </p>
                  )}
                </div>
                <span class="timeline-date">
                  {new Date(project.date).toLocaleDateString("en-US", {
                    month: "short",
                    year: "2-digit",
                  })}
                </span>
              </div>
            ))}
          </div>
          <a href="/projects" class="see-all">
            Explore all
          </a>
        </div>
      </section>
    )
  }

  {
    featuredWork.length > 0 && (
      <section>
        <div class="container section-wrapper border-dashed-b animate-in">
          <h2 class="section-title">
            <SquarePen size={20} class="section-title-icon" />
            Work Case Studies
          </h2>
          <div class="timeline">
            {featuredWork.map((work) => (
              <div class="timeline-item">
                <div class="timeline-content">
                  <a href={`/work/${work.slug}`} class="post-link">
                    {work.data.title}
                  </a>
                </div>
                <span class="timeline-date">
                  {new Date(work.data.date).toLocaleDateString("en-US", {
                    month: "short",
                    year: "2-digit",
                  })}
                </span>
              </div>
            ))}
          </div>
          <a href="/work" class="see-all">
            Explore all
          </a>
        </div>
      </section>
    )
  }

  {
    posts.length > 0 && (
      <section>
        <div class="container section-wrapper animate-in">
          <h2 class="section-title">
            <Book size={20} class="section-title-icon" />
            Writing
          </h2>
          <div class="timeline">
            {posts.map((post) => (
              <div class="timeline-item">
                <div class="timeline-content">
                  <a href={`/blog/${post.slug}`} class="post-link">
                    {post.title}
                  </a>
                </div>
                <span class="timeline-date">
                  {new Date(post.date).toLocaleDateString("en-US", {
                    month: "short",
                    year: "2-digit",
                    day: "numeric",
                  })}
                </span>
              </div>
            ))}
          </div>
          <a href="/blog" class="see-all">
            Read all posts
          </a>
        </div>
      </section>
    )
  }
</Base>

<style>
  .intro {
    color: var(--text-muted);
    line-height: 1.8;
  }

  .now-list {
    padding-left: var(--space-lg);
  }

  .post-link {
    font-family: var(--font-mono);
    font-weight: 500;
    color: var(--text);
  }

  .post-link:hover {
    color: var(--accent);
  }

  .post-desc {
    margin: var(--space-xs) 0 0;
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .see-all {
    display: inline-block;
    margin-top: var(--space-lg);
    font-size: 0.9375rem;
    color: var(--text-muted);
  }

  .see-all:hover {
    color: var(--accent);
  }

  @media (max-width: 640px) {
    .see-all {
      margin-left: 0;
    }
  }
</style>
